# 會話安全機制說明

## 已實現的安全功能

### 1. 自動登出機制 ⏰
- **不活動時間限制：** 30分鐘沒有用戶活動後自動登出
- **活動檢測：** 監聽滑鼠移動、鍵盤輸入、滾動、點擊等用戶活動
- **定期檢查：** 每分鐘檢查一次會話是否過期
- **自動重定向：** 會話過期時自動跳轉到登錄頁面並顯示過期提示

### 2. 關閉瀏覽器後重新登錄 🔒
- **會話存儲：** 使用 sessionStorage 而不是持久化存儲
- **瀏覽器關閉清理：** 關閉瀏覽器標籤頁後 sessionStorage 自動清空
- **會話 Cookie：** Cookie 不設置過期時間，瀏覽器關閉後自動失效

### 3. 服務器啟動時無自動登錄 ✅
- **本地會話檢查：** 啟動時先檢查本地 sessionStorage 是否有效
- **避免不必要的服務器請求：** 沒有有效本地會話時不會向服務器發送認證請求
- **強制登錄：** 確保每次新會話都需要輸入用戶名和密碼

### 4. 防止內容閃爍 🎨
- **專用加載頁面：** 認證檢查期間顯示美觀的加載動畫
- **重定向狀態管理：** 跳轉過程中顯示加載狀態，避免顯示頁面內容
- **無縫用戶體驗：** 確保在認證和重定向過程中用戶看不到未授權的內容

## 工作流程

### 登錄流程
1. 用戶輸入用戶名和密碼
2. 服務器驗證憑證
3. 生成 30分鐘有效期的 JWT token
4. 設置會話 cookie（瀏覽器關閉後過期）
5. 在 sessionStorage 中記錄會話信息

### 會話維護
1. 用戶每次活動都會更新 sessionStorage 中的時間戳
2. 每分鐘檢查會話是否超過 30分鐘無活動
3. 超時後自動執行登出流程

### 登出流程
1. 清除用戶狀態
2. 清除 sessionStorage
3. 清除服務器端 cookie
4. 重定向到登錄頁面

## 安全參數

```javascript
// 自動登出時間（30分鐘）
const AUTO_LOGOUT_TIME = 30 * 60 * 1000;

// 會話檢查間隔（1分鐘）
const SESSION_CHECK_INTERVAL = 60 * 1000;

// JWT token 有效期（30分鐘）
const JWT_EXPIRES_IN = '30m';
```

## 測試方法

### 測試自動登出
1. 登錄系統
2. 等待 30分鐘不進行任何操作
3. 系統應自動登出並顯示「會話已過期」

### 測試瀏覽器關閉重登錄
1. 登錄系統
2. 關閉瀏覽器標籤頁
3. 重新打開網站
4. 應直接跳轉到登錄頁面

### 測試服務器重啟
1. 停止開發服務器
2. 重新啟動服務器
3. 訪問網站
4. 應直接跳轉到登錄頁面，不會自動登錄

## 注意事項

- 所有認證狀態都存儲在 sessionStorage 中，確保瀏覽器關閉後清除
- JWT token 和 cookie 都設置了較短的有效期
- 用戶活動會自動延長會話時間
- 系統會在控制台中記錄詳細的認證日誌以便調試