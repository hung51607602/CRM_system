# Quota 扣款功能說明

## 功能概述

本系統現已實現會員掃描二維碼後自動扣除 quota（配額）的功能。當會員掃描由管理員創建的產品二維碼時，系統會根據二維碼上的價格自動扣除會員的配額。

## 主要功能

### 1. 二維碼掃描與扣款

- **適用角色**：普通會員（regular-member）、高級會員（premium-member）、會員（member）
- **掃描頁面**：`/attendance/scan`
- **扣款流程**：
  1. 會員使用掃描功能掃描產品二維碼
  2. 系統顯示二維碼信息（編號、地區、產品描述、價格）
  3. 系統自動獲取會員當前配額
  4. 顯示扣款預覽（當前配額、消費金額、扣款後剩餘）
  5. 會員確認扣款
  6. 系統檢查配額是否足夠
  7. 扣款成功或顯示"餘額不足"錯誤

### 2. 餘額不足保護

- **配額檢查**：系統會在扣款前檢查會員的配額是否足夠
- **錯誤提示**：如果配額不足，系統會顯示"餘額不足"並拒絕扣款
- **配額保護**：配額不會變為負數，最小值為 0

### 3. 數據同步

扣款後，quota 的更新會立即同步到整個系統：

- **會員個人資料頁面**（`/member_management/my_profile`）：會員可以查看最新的剩餘配額
- **管理員會員管理頁面**（`/account_management/member`）：管理員可以查看所有會員的最新配額
- **數據庫**：配額變更會立即保存到 MongoDB 數據庫

## API 端點

### 新增 API：QR Code 扣款

**端點**：`POST /api/qrcode/deduct`

**功能**：處理會員掃描二維碼後的配額扣款

**請求參數**：
```json
{
  "qrCodeData": "二維碼的 JSON 數據字符串"
}
```

**成功響應**（200）：
```json
{
  "success": true,
  "message": "扣款成功",
  "data": {
    "qrCode": {
      "number": "0001",
      "regionName": "灣仔",
      "productDescription": "產品名稱",
      "price": 2
    },
    "transaction": {
      "previousQuota": 5,
      "deductedAmount": 2,
      "newQuota": 3,
      "memberName": "會員姓名",
      "transactionTime": "2025-10-21T10:00:00.000Z"
    }
  }
}
```

**餘額不足響應**（400）：
```json
{
  "success": false,
  "message": "餘額不足",
  "data": {
    "currentQuota": 1,
    "requiredAmount": 2,
    "shortage": 1
  }
}
```

**權限錯誤響應**：
- 未登錄（401）：`{ "success": false, "message": "未登錄，請先登錄" }`
- 非會員（403）：`{ "success": false, "message": "只有會員可以使用此功能" }`

## 數據庫更新

當扣款成功時，系統會更新以下字段：

- **quota**：剩餘配額 = 當前配額 - 二維碼價格
- **usedTickets**：已使用套票次數 = 原已使用次數 + 扣款金額

計算公式：
```
新的 quota = 當前 quota - 二維碼價格
新的 usedTickets = 當前 usedTickets + 二維碼價格
```

## 角色權限

### 會員角色（可以掃描並扣款）
- `member`：會員
- `regular-member`：普通會員
- `premium-member`：高級會員

### 教練角色（只能查看，不能扣款）
- `trainer`：教練可以掃描查看二維碼信息，但不會進行扣款

### 管理員角色
- `admin`：管理員可以創建二維碼、查看所有會員的配額狀態

## 使用流程示例

### 場景 1：扣款成功

1. **會員 A** 當前配額：5
2. **掃描二維碼**：價格為 2
3. **系統檢查**：5 >= 2 ✓
4. **扣款成功**：配額變為 3
5. **顯示消息**：「✅ 扣款成功！已扣除 2 配額，剩餘配額: 3」

### 場景 2：餘額不足

1. **會員 B** 當前配額：1
2. **掃描二維碼**：價格為 2
3. **系統檢查**：1 < 2 ✗
4. **扣款失敗**：配額保持為 1
5. **顯示錯誤**：「餘額不足！您的剩餘配額為 1，需要 2」

## 技術實現細節

### 前端實現
- **文件**：`/crm_system/src/app/attendance/scan/page.tsx`
- **新增功能**：
  - `handleProductPayment()` 函數處理扣款邏輯
  - 扣款前顯示會員資料和扣款預覽
  - 扣款成功後顯示成功消息並清空掃描結果
  - 錯誤處理和用戶友好的錯誤提示

### 後端實現
- **文件**：`/crm_system/src/app/api/qrcode/deduct/route.ts`
- **安全性**：
  - 使用 JWT token 驗證用戶身份
  - 檢查用戶角色權限
  - 驗證二維碼有效性
  - 原子性操作確保數據一致性
- **緩存管理**：扣款成功後清除相關緩存，確保數據同步

### 數據模型
- **Account Model**（`/crm_system/src/models/Account.ts`）
  - `quota`：剩餘配額（必須 >= 0）
  - `usedTickets`：已使用套票次數
  - `initialTickets`：初始套票次數
  - `addedTickets`：累計添加的套票次數

- **QRCode Model**（`/crm_system/src/models/QRCode.ts`）
  - `price`：二維碼對應的價格
  - `qrCodeNumber`：二維碼編號
  - `productDescription`：產品描述
  - `regionCode`：地區編號

## 注意事項

1. **配額不能為負數**：系統會確保 quota 始終 >= 0
2. **所有會員類型統一處理**：普通會員、高級會員和會員使用相同的 quota 字段
3. **數據同步**：扣款成功後會清除緩存，確保所有頁面顯示最新數據
4. **權限控制**：只有登錄的會員才能進行扣款操作
5. **錯誤處理**：系統會捕獲並友好地顯示所有可能的錯誤

## 測試建議

### 測試案例 1：正常扣款
1. 創建一個會員，設置 quota = 10
2. 創建一個二維碼，設置 price = 3
3. 用會員賬號登錄並掃描二維碼
4. 確認扣款
5. 驗證：quota 變為 7，usedTickets 增加 3

### 測試案例 2：餘額不足
1. 創建一個會員，設置 quota = 1
2. 創建一個二維碼，設置 price = 5
3. 用會員賬號登錄並掃描二維碼
4. 嘗試確認扣款
5. 驗證：顯示"餘額不足"錯誤，quota 保持為 1

### 測試案例 3：邊界條件
1. 創建一個會員，設置 quota = 5
2. 創建一個二維碼，設置 price = 5
3. 用會員賬號登錄並掃描二維碼
4. 確認扣款
5. 驗證：quota 變為 0（不會變為負數）

### 測試案例 4：不同會員類型
1. 分別測試 regular-member、premium-member、member 三種角色
2. 驗證所有角色都能正常扣款
3. 驗證 quota 字段在所有角色中都正確更新

### 測試案例 5：數據同步
1. 會員扣款後，刷新個人資料頁面
2. 管理員查看該會員的詳情
3. 驗證兩處顯示的 quota 一致且為最新值

## 未來改進建議

1. **交易記錄**：添加一個交易歷史表，記錄所有的扣款操作
2. **退款功能**：支持管理員撤銷錯誤的扣款操作
3. **批量操作**：支持一次掃描多個二維碼
4. **通知功能**：扣款成功後發送通知給會員
5. **報表功能**：生成會員消費報表和二維碼使用統計

