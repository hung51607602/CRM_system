# Quota 扣款功能使用指南

## 快速開始

本指南將幫助您快速上手使用會員二維碼掃描扣款功能。

---

## 管理員操作指南

### 1. 創建產品二維碼

1. 以管理員身份登錄系統
2. 進入二維碼管理頁面（如 `/qrcode/generate`）
3. 填寫以下信息：
   - **地區編號**：選擇 WC（灣仔）、WTS（黃大仙）或 SM（石門）
   - **產品描述**：輸入產品或服務名稱（例如："健身課程"、"營養諮詢"）
   - **價格**：設置扣款金額（例如：2 表示扣除 2 個配額）
4. 點擊「創建」按鈕
5. 系統會生成一個唯一的二維碼
6. 保存或列印二維碼供會員掃描

### 2. 查看會員配額

1. 進入「會員帳號管理」頁面（`/account_management/member`）
2. 選擇要查看的會員
3. 在詳情頁面可以看到：
   - **剩餘配額**（quota）：會員當前可用的配額
   - **續卡次數**（renewalCount）：會員的續卡記錄
   - **初始套票**（initialTickets）：創建會員時的配額
   - **累計添加套票**（addedTickets）：所有續卡增加的總和
   - **已使用套票**（usedTickets）：已消費的配額總數

### 3. 為會員添加配額

1. 在「會員帳號管理」頁面選擇會員
2. 點擊「添加配額」或「編輯」按鈕
3. 輸入要添加的配額數量
4. 系統會自動更新：
   - `quota` 增加相應數量
   - `addedTickets` 累計增加
   - `renewalCount` 增加 1

---

## 會員操作指南

### 1. 掃描二維碼並扣款

#### 步驟 1：進入掃描頁面
1. 以會員身份登錄系統（支持 regular-member、premium-member、member 角色）
2. 進入「掃描簽到」頁面（`/attendance/scan`）

#### 步驟 2：開始掃描
1. 點擊「開始掃描二維碼」按鈕
2. 授權相機權限（如果是第一次使用）
3. 將相機對準二維碼

#### 步驟 3：確認信息
掃描成功後，系統會顯示：
- **二維碼信息**：
  - 編號
  - 地區
  - 產品描述
  - 價格
- **會員資料**（自動加載）：
  - 您的姓名
  - **當前剩餘配額**
  - **本次消費金額**
  - **扣款後剩餘配額**

#### 步驟 4：確認扣款
1. 檢查扣款信息是否正確
2. 確認配額足夠（如果不足會顯示警告）
3. 點擊「確認扣款」按鈕
4. 等待系統處理

#### 步驟 5：查看結果
- **成功**：顯示「✅ 扣款成功！已扣除 X 配額，剩餘配額: Y」
- **失敗**：顯示錯誤信息（例如「餘額不足！您的剩餘配額為 1，需要 2」）

### 2. 查看個人配額

1. 登錄後進入「個人資料」頁面（`/member_management/my_profile`）
2. 在頁面上可以看到：
   - **剩餘配額**：以大字體顯示
   - **初始套票**：您加入時的配額
   - **累計添加套票**：所有續卡增加的總配額
   - **已使用套票**：您已消費的總配額
   - **續卡次數**：您的續卡記錄

---

## 常見場景

### 場景 1：正常購買產品

**背景**：會員 A 有 10 個配額，想購買價格為 3 的產品

1. 會員 A 掃描二維碼
2. 系統顯示：
   - 當前配額：10
   - 本次消費：3
   - 扣款後剩餘：7
3. 會員 A 點擊「確認扣款」
4. 扣款成功，新配額：7

### 場景 2：配額不足

**背景**：會員 B 只有 1 個配額，想購買價格為 3 的產品

1. 會員 B 掃描二維碼
2. 系統顯示：
   - 當前配額：1
   - 本次消費：3
   - **⚠️ 配額不足，無法完成交易**
3. 會員 B 點擊「確認扣款」
4. 系統顯示：「餘額不足！您的剩餘配額為 1，需要 3」
5. 扣款失敗，配額保持為 1
6. **解決方案**：會員需要聯繫管理員添加配額

### 場景 3：配額剛好用完

**背景**：會員 C 有 5 個配額，購買價格為 5 的產品

1. 會員 C 掃描二維碼
2. 系統顯示：
   - 當前配額：5
   - 本次消費：5
   - 扣款後剩餘：0
3. 會員 C 點擊「確認扣款」
4. 扣款成功，新配額：0
5. **注意**：下次購買前需要先添加配額

---

## 教練功能

教練（trainer）可以掃描二維碼查看產品信息，但**不能**進行扣款操作。

1. 教練登錄後進入掃描頁面
2. 掃描二維碼後只能查看信息
3. 沒有「確認扣款」按鈕
4. 只有「關閉」按鈕返回

---

## 注意事項

### 會員須知

1. **配額不會變為負數**：系統會確保您的配額始終 >= 0
2. **即時更新**：扣款後，您的配額會立即更新，刷新頁面即可看到
3. **無法退款**：扣款後無法自行取消，如有問題請聯繫管理員
4. **賬戶激活**：只有激活的賬戶才能進行扣款操作

### 管理員須知

1. **價格設置**：二維碼價格可以是任意非負數（包括 0）
2. **配額管理**：建議定期檢查會員配額，及時為需要的會員添加配額
3. **數據同步**：扣款後數據會立即保存到數據庫並清除緩存
4. **會員類型**：所有會員類型（member、regular-member、premium-member）使用相同的配額系統

---

## 故障排除

### 問題 1：掃描後沒有反應

**可能原因**：
- 相機權限未授權
- 二維碼格式不正確
- 二維碼已失效

**解決方案**：
- 檢查瀏覽器的相機權限設置
- 確認二維碼是由系統生成的產品二維碼
- 聯繫管理員重新生成二維碼

### 問題 2：顯示「未登錄」錯誤

**可能原因**：
- 登錄會話已過期
- 未登錄系統

**解決方案**：
- 重新登錄系統
- 確認使用正確的會員賬號

### 問題 3：顯示「餘額不足」

**可能原因**：
- 當前配額少於二維碼價格

**解決方案**：
- 聯繫管理員添加配額
- 選擇價格較低的產品

### 問題 4：配額顯示不正確

**可能原因**：
- 頁面緩存未刷新

**解決方案**：
- 刷新瀏覽器頁面（F5 或 Cmd+R）
- 重新登錄系統

---

## 技術支持

如遇到其他問題，請聯繫系統管理員並提供以下信息：

1. 您的會員賬號（用戶名）
2. 問題發生的時間
3. 錯誤信息截圖
4. 操作步驟描述

---

## 更新日誌

### Version 1.0（2025-10-21）

- ✅ 實現會員掃描二維碼扣款功能
- ✅ 支持普通會員、高級會員和會員三種角色
- ✅ 添加餘額不足保護機制
- ✅ 配額更新實時同步到所有頁面
- ✅ 創建詳細的 API 文檔和使用指南

